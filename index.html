<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>GasSwap ‚Äì BNB (BSC) ‚Üí TRX Cross-Swap</title>
  <meta name="description" content="Deposit BNB (BSC) and receive TRX automatically. Simple cross-chain swap request UI." />
  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- QRCode.js -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
  <style>
    a { word-break: break-all; }
  </style>
</head>
<body class="min-h-screen bg-slate-950 text-slate-100">
  <header class="border-b border-slate-800 bg-slate-900/60 backdrop-blur sticky top-0 z-20">
    <div class="max-w-5xl mx-auto px-4 py-3 flex items-center justify-between">
      <div class="flex items-center gap-2">
        <div class="w-8 h-8 rounded-xl bg-gradient-to-tr from-emerald-400 to-cyan-400"></div>
        <h1 class="text-lg font-semibold tracking-tight">GasSwap</h1>
        <span class="ml-2 text-xs text-slate-400">v0.2 ‚Äì Static UI</span>
      </div>
      <select id="langSelect" class="bg-slate-800 text-slate-100 text-sm rounded-xl px-3 py-2 border border-slate-700 focus:ring-2 focus:ring-emerald-400">
        <option value="auto">üåê Auto</option>
        <option value="en">English</option>
        <option value="ko">ÌïúÍµ≠Ïñ¥</option>
        <option value="ja">Êó•Êú¨Ë™û</option>
        <option value="zh">‰∏≠Êñá</option>
        <option value="es">Espa√±ol</option>
      </select>
    </div>
  </header>

  <main class="max-w-5xl mx-auto px-4 py-8">
    <section class="mb-6">
      <div class="rounded-2xl border border-slate-800 bg-slate-900 p-5">
        <h2 id="title" class="text-2xl font-semibold mb-2">BNB (BSC) ‚Üí TRX Cross-Swap</h2>
        <p id="subtitle" class="text-slate-400 text-sm leading-relaxed">
          Deposit BNB (BSC) and receive TRX automatically after confirmation.
        </p>
      </div>
    </section>

    <section class="grid md:grid-cols-2 gap-6">
      <!-- Left: Form -->
      <div class="rounded-2xl border border-slate-800 bg-slate-900 p-5">
        <h3 id="formTitle" class="text-lg font-semibold mb-4">Create deposit session</h3>
        <form id="swapForm" class="space-y-4" novalidate>
          <div>
            <label for="sender" id="labelSender" class="block text-sm text-slate-300 mb-1">Sender (BNB BSC)</label>
            <input id="sender" name="sender" type="text"
              class="w-full rounded-xl bg-slate-950 border border-slate-800 focus:border-emerald-400 focus:ring-emerald-400 px-4 py-3 text-sm"
              placeholder="0x‚Ä¶ (BNB BSC address)" required />
            <p id="senderHelp" class="text-xs text-slate-500 mt-1">Must be a valid BNB (BSC) wallet (0x‚Ä¶40 hex chars).</p>
          </div>

          <div>
            <label for="receiver" id="labelReceiver" class="block text-sm text-slate-300 mb-1">Receiver (TRX)</label>
            <input id="receiver" name="receiver" type="text"
              class="w-full rounded-xl bg-slate-950 border border-slate-800 focus:border-emerald-400 focus:ring-emerald-400 px-4 py-3 text-sm"
              placeholder="T‚Ä¶ (TRON base58 address)" required />
            <p id="receiverHelp" class="text-xs text-slate-500 mt-1">Should start with T and be 34 chars (base58).</p>
          </div>

          <div id="formError" class="hidden rounded-xl border border-red-500/40 bg-red-500/10 text-red-200 text-sm px-3 py-2"></div>

          <button id="startBtn" type="submit"
            class="w-full rounded-xl px-4 py-3 bg-emerald-500 text-slate-950 font-semibold hover:bg-emerald-400 focus:outline-none">
            Start Swap
          </button>
        </form>

        <!-- Explorers for user-provided addresses -->
        <div id="userExplorers" class="hidden mt-5 text-sm text-slate-400 space-y-2">
          <div id="youCanCheck">You can verify your wallets on explorers:</div>
          <a id="userBscLink" target="_blank" class="block underline hover:text-emerald-300"></a>
          <a id="userTrxLink" target="_blank" class="block underline hover:text-emerald-300"></a>
        </div>
      </div>

      <!-- Right: Session panel -->
      <div class="rounded-2xl border border-slate-800 bg-slate-900 p-5">
        <h3 id="sessionTitle" class="text-lg font-semibold mb-4">Deposit session</h3>
        <div id="inactiveHint" class="text-sm text-slate-400">
          Fill the form and press <span class="font-semibold">Start Swap</span> to generate your session.
        </div>

        <div id="sessionPanel" class="hidden space-y-4">
          <div>
            <div class="text-xs text-slate-400" id="depositTo">Deposit to (fixed address)</div>
            <div class="mt-1 flex items-center gap-2">
              <code id="depositAddress" class="text-emerald-200 break-all"></code>
              <button id="copyDeposit" class="text-xs px-2 py-1 rounded-lg border border-slate-700 hover:bg-slate-800">Copy</button>
            </div>
          </div>

          <div class="grid grid-cols-2 gap-4">
            <div>
              <div id="qr" class="bg-white p-2 inline-block rounded-xl"></div>
              <div class="text-[10px] text-slate-500 mt-1" id="qrHint">Scan to deposit</div>
            </div>
            <div>
              <div class="text-xs text-slate-400" id="deadlineLabel">Deposit deadline</div>
              <div id="countdown" class="text-3xl font-mono mt-1">01:00:00</div>
              <div class="text-xs text-slate-500 mt-2" id="expireNote">If the timer expires, the session may be invalidated.</div>
            </div>
          </div>

          <div class="text-sm text-slate-400">
            <div id="serverCheck">Server wallet explorers:</div>
            <a id="serverBscLink" target="_blank" class="block underline hover:text-emerald-300"></a>
            <a id="serverTrxLink" target="_blank" class="block underline hover:text-emerald-300"></a>
          </div>
        </div>
      </div>
    </section>

    <!-- Persistent Footer Explorers -->
    <section class="mt-8 rounded-2xl border border-slate-800 bg-slate-900 p-5">
      <div id="footerTitle" class="text-sm text-slate-300 mb-2">üì° Server Wallets (always visible)</div>
      <a id="footerBsc" target="_blank" class="block underline hover:text-emerald-300"></a>
      <a id="footerTrx" target="_blank" class="block underline hover:text-emerald-300"></a>
    </section>

    <section class="mt-4 text-xs text-slate-500 leading-relaxed">
      <p id="legal1">This page is a static UI prototype. No wallets are connected here. Always verify addresses and transactions on-chain.</p>
      <p id="legal2">Language auto-detection uses public IP geolocation (client-based) with fallbacks.</p>
    </section>
  </main>

  <footer class="mt-10 py-10 text-center text-xs text-slate-500">
    ¬© <span id="year"></span> GasSwap. All rights reserved.
  </footer>

  <script>
    // ====== CONFIG ======
    const CONFIG = {
      SERVER_WALLETS: {
        BSC: "0xDA1E8b362DDe013EA87Cf8984D64490c1900d231", // BNB (BSC) deposit address (fixed)
        TRX: "TMq11111111111111111111111111111111"         // TRX payout wallet
      },
      SESSION_SECONDS: 3600,
      FORM_ENDPOINT: "https://89.147.101.71/api/swap" // ‚Üê Ïó¨Í∏∞Ïóê Ïã§Ï†ú Ï†úÏ∂ú ÏóîÎìúÌè¨Ïù∏Ìä∏ ÏÑ§Ï†ï
    };

    // ====== I18N ======
    const I18N = {
      en: {
        title: "BNB (BSC) ‚Üí TRX Cross-Swap",
        subtitle: "Deposit BNB (BSC) and receive TRX automatically after confirmation.",
        formTitle: "Create deposit session",
        sender: "Sender (BNB BSC)",
        receiver: "Receiver (TRX)",
        senderHelp: "Must be a valid BNB (BSC) wallet (0x‚Ä¶40 hex chars).",
        receiverHelp: "Should start with T and be 34 chars (base58).",
        start: "Start Swap",
        err_sender: "Invalid BNB (BSC) address.",
        err_receiver: "Invalid TRON address.",
        youCanCheck: "You can verify your wallets on explorers:",
        sessionTitle: "Deposit session",
        inactiveHint: "Fill the form and press Start Swap to generate your session.",
        depositTo: "Deposit to (fixed address)",
        copy: "Copy",
        qrHint: "Scan to deposit",
        deadline: "Deposit deadline",
        expireNote: "If the timer expires, the session may be invalidated.",
        serverCheck: "Server wallet explorers:",
        footerTitle: "üì° Server Wallets (always visible)",
        legal1: "This page is a static UI prototype. No wallets are connected here. Always verify addresses and transactions on-chain.",
        legal2: "Language auto-detection uses public IP geolocation.",
        bscSenderLink: "Sender wallet on BscScan (BNB BSC)",
        trxReceiverLink: "Receiver wallet on TRONSCAN",
        bscServerLink: "Server wallet on BscScan (BNB BSC)",
        trxServerLink: "Server wallet on TRONSCAN"
      },
      ko: {
        title: "BNB (BSC) ‚Üí TRX ÌÅ¨Î°úÏä§Ïä§Ïôë",
        subtitle: "BNB(BSC)Î•º ÏûÖÍ∏àÌïòÎ©¥ ÌôïÏù∏ ÌõÑ TRXÍ∞Ä ÏûêÎèô Ï†ÑÏÜ°Îê©ÎãàÎã§.",
        formTitle: "ÏûÖÍ∏à ÏÑ∏ÏÖò ÎßåÎì§Í∏∞",
        sender: "Î≥¥ÎÇ¥Îäî ÏßÄÍ∞ë (BNB BSC)",
        receiver: "Î∞õÎäî ÏßÄÍ∞ë (TRX)",
        senderHelp: "0xÎ°ú ÏãúÏûëÌïòÎäî 40ÏûêÎ¶¨ BNB(BSC) Ï£ºÏÜåÏó¨Ïïº Ìï©ÎãàÎã§.",
        receiverHelp: "TÎ°ú ÏãúÏûëÌïòÎäî 34ÏûêÎ¶¨(base58) Ï£ºÏÜåÏó¨Ïïº Ìï©ÎãàÎã§.",
        start: "Ïä§Ïôë ÏãúÏûëÌïòÍ∏∞",
        err_sender: "BNB(BSC) Ï£ºÏÜå ÌòïÏãùÏù¥ Ïò¨Î∞îÎ•¥ÏßÄ ÏïäÏäµÎãàÎã§.",
        err_receiver: "TRON Ï£ºÏÜå ÌòïÏãùÏù¥ Ïò¨Î∞îÎ•¥ÏßÄ ÏïäÏäµÎãàÎã§.",
        youCanCheck: "ÌÉêÏÉâÍ∏∞ÏóêÏÑú ÏßÅÏ†ë ÌôïÏù∏ÌïòÏÑ∏Ïöî:",
        sessionTitle: "ÏûÖÍ∏à ÏÑ∏ÏÖò",
        inactiveHint: "Ìèº ÏûëÏÑ± ÌõÑ ‚ÄòÏä§Ïôë ÏãúÏûëÌïòÍ∏∞‚ÄôÎ•º ÎàÑÎ•¥Î©¥ ÏÑ∏ÏÖòÏù¥ ÏÉùÏÑ±Îê©ÎãàÎã§.",
        depositTo: "ÏûÖÍ∏à Ï£ºÏÜå (Í≥†Ï†ï)",
        copy: "Î≥µÏÇ¨",
        qrHint: "QRÎ°ú ÏûÖÍ∏à",
        deadline: "ÏûÖÍ∏à ÏãúÌïú",
        expireNote: "ÏãúÌïúÏù¥ ÏßÄÎÇòÎ©¥ ÏÑ∏ÏÖòÏù¥ Î¨¥Ìö® Ï≤òÎ¶¨Îê† Ïàò ÏûàÏäµÎãàÎã§.",
        serverCheck: "ÏÑúÎ≤Ñ ÏßÄÍ∞ë ÌÉêÏÉâÍ∏∞:",
        footerTitle: "üì° ÏÑúÎ≤Ñ ÏßÄÍ∞ë (Ìï≠ÏÉÅ ÌëúÏãú)",
        legal1: "Ïù¥ ÌéòÏù¥ÏßÄÎäî Ï†ïÏ†Å UI ÏãúÏ†úÌíàÏûÖÎãàÎã§. ÏßÄÍ∞ë Ïó∞Í≤∞ÏùÄ ÏóÜÏäµÎãàÎã§. Ï£ºÏÜåÏôÄ Ìä∏ÎûúÏû≠ÏÖòÏùÄ Ïò®Ï≤¥Ïù∏ÏóêÏÑú ÌôïÏù∏ÌïòÏÑ∏Ïöî.",
        legal2: "Ïñ∏Ïñ¥ ÏûêÎèô Í∞êÏßÄÎäî Í≥µÏö© IP ÏßÄÏò§Î°úÏºÄÏù¥ÏÖòÏùÑ ÏÇ¨Ïö©Ìï©ÎãàÎã§.",
        bscSenderLink: "Î≥¥ÎÇ¥Îäî ÏßÄÍ∞ë ‚Äì BscScan (BNB BSC)",
        trxReceiverLink: "Î∞õÎäî ÏßÄÍ∞ë ‚Äì TRONSCAN",
        bscServerLink: "ÏÑúÎ≤Ñ ÏßÄÍ∞ë ‚Äì BscScan (BNB BSC)",
        trxServerLink: "ÏÑúÎ≤Ñ ÏßÄÍ∞ë ‚Äì TRONSCAN"
      },
      ja: {
        title: "BNB (BSC) ‚Üí TRX „ÇØ„É≠„Çπ„Çπ„ÉØ„ÉÉ„Éó",
        subtitle: "BNB(BSC)„ÇíÂÖ•Èáë„Åô„Çã„Å®„ÄÅÁ¢∫Ë™çÂæå„Å´TRX„ÅåËá™ÂãïÈÄÅ‰ªò„Åï„Çå„Åæ„Åô„ÄÇ",
        formTitle: "ÂÖ•Èáë„Çª„ÉÉ„Ç∑„Éß„É≥„Çí‰ΩúÊàê",
        sender: "ÈÄÅ‰ø°ÂÖÉ (BNB BSC)",
        receiver: "Âèó‰ø°ÂÖà (TRX)",
        senderHelp: "0x„ÅßÂßã„Åæ„Çã40Ê°Å„ÅÆBNB(BSC)„Ç¢„Éâ„É¨„Çπ„ÅåÂøÖË¶Å„Åß„Åô„ÄÇ",
        receiverHelp: "T„ÅßÂßã„Åæ„Çã34Ê°ÅÔºàbase58Ôºâ„ÅÆ„Ç¢„Éâ„É¨„Çπ„ÅåÂøÖË¶Å„Åß„Åô„ÄÇ",
        start: "„Çπ„ÉØ„ÉÉ„ÉóÈñãÂßã",
        err_sender: "BNB(BSC)„Ç¢„Éâ„É¨„Çπ„ÅåÁÑ°Âäπ„Åß„Åô„ÄÇ",
        err_receiver: "TRON„Ç¢„Éâ„É¨„Çπ„ÅåÁÑ°Âäπ„Åß„Åô„ÄÇ",
        youCanCheck: "„Ç®„ÇØ„Çπ„Éó„É≠„Éº„É©„Éº„ÅßÁ¢∫Ë™ç„Åß„Åç„Åæ„ÅôÔºö",
        sessionTitle: "ÂÖ•Èáë„Çª„ÉÉ„Ç∑„Éß„É≥",
        inactiveHint: "„Éï„Ç©„Éº„É†ÂÖ•ÂäõÂæå„Äå„Çπ„ÉØ„ÉÉ„ÉóÈñãÂßã„Äç„Åß„Çª„ÉÉ„Ç∑„Éß„É≥„ÇíÁîüÊàê„Åó„Åæ„Åô„ÄÇ",
        depositTo: "ÂÖ•ÈáëÂÖàÔºàÂõ∫ÂÆö„Ç¢„Éâ„É¨„ÇπÔºâ",
        copy: "„Ç≥„Éî„Éº",
        qrHint: "QR„ÅßÂÖ•Èáë",
        deadline: "ÂÖ•ÈáëÊúüÈôê",
        expireNote: "ÊúüÈôêÂàá„Çå„ÅÆÂ†¥Âêà„ÄÅ„Çª„ÉÉ„Ç∑„Éß„É≥„ÅØÁÑ°Âäπ„Å´„Å™„ÇãÂ†¥Âêà„Åå„ÅÇ„Çä„Åæ„Åô„ÄÇ",
        serverCheck: "„Çµ„Éº„Éê„Éº„Ç¶„Ç©„É¨„ÉÉ„ÉàÔºà„Ç®„ÇØ„Çπ„Éó„É≠„Éº„É©„ÉºÔºâÔºö",
        footerTitle: "üì° „Çµ„Éº„Éê„Éº„Ç¶„Ç©„É¨„ÉÉ„ÉàÔºàÂ∏∏ÊôÇË°®Á§∫Ôºâ",
        legal1: "„Åì„ÅÆ„Éö„Éº„Ç∏„ÅØÈùôÁöÑUI„ÅÆË©¶‰ΩúÂìÅ„Åß„Åô„ÄÇ„Ç¶„Ç©„É¨„ÉÉ„ÉàÊé•Á∂ö„ÅØ„ÅÇ„Çä„Åæ„Åõ„Çì„ÄÇ„Ç™„É≥„ÉÅ„Çß„Éº„É≥„ÅßÂøÖ„ÅöÁ¢∫Ë™ç„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ",
        legal2: "Ë®ÄË™û„ÅÆËá™ÂãïÂà§ÂÆö„ÅØÂÖ¨ÂÖ±„ÅÆIP„Ç∏„Ç™„É≠„Ç±„Éº„Ç∑„Éß„É≥„Çí‰ΩøÁî®„Åó„Åæ„Åô„ÄÇ",
        bscSenderLink: "ÈÄÅ‰ø°ÂÖÉ ‚Äì BscScan (BNB BSC)",
        trxReceiverLink: "Âèó‰ø°ÂÖà ‚Äì TRONSCAN",
        bscServerLink: "„Çµ„Éº„Éê„Éº ‚Äì BscScan (BNB BSC)",
        trxServerLink: "„Çµ„Éº„Éê„Éº ‚Äì TRONSCAN"
      },
      zh: {
        title: "BNB (BSC) ‚Üí TRX Ë∑®ÈìæÂÖëÊç¢",
        subtitle: "ÂÖ•Èáë BNB(BSC)ÔºåÁ°ÆËÆ§ÂêéÂ∞ÜËá™Âä®ÂèëÈÄÅ TRX„ÄÇ",
        formTitle: "ÂàõÂª∫ÂÖ•Èáë‰ºöËØù",
        sender: "ÂèëÈÄÅÂú∞ÂùÄ (BNB BSC)",
        receiver: "Êé•Êî∂Âú∞ÂùÄ (TRX)",
        senderHelp: "ÂøÖÈ°ª‰∏∫ 0x ÂºÄÂ§¥ÁöÑ 40 ‰Ωç BNB(BSC) Âú∞ÂùÄ„ÄÇ",
        receiverHelp: "ÂøÖÈ°ª‰ª• T ÂºÄÂ§¥ÔºåÂÖ± 34 ‰ΩçÔºàbase58Ôºâ„ÄÇ",
        start: "ÂºÄÂßãÂÖëÊç¢",
        err_sender: "Êó†ÊïàÁöÑ BNB(BSC) Âú∞ÂùÄ„ÄÇ",
        err_receiver: "Êó†ÊïàÁöÑ TRON Âú∞ÂùÄ„ÄÇ",
        youCanCheck: "ÂèØÂú®Âå∫ÂùóÊµèËßàÂô®Êü•ÁúãÔºö",
        sessionTitle: "ÂÖ•Èáë‰ºöËØù",
        inactiveHint: "Â°´ÂÜôË°®ÂçïÂπ∂ÁÇπÂáª‚ÄúÂºÄÂßãÂÖëÊç¢‚Äù‰ª•ÁîüÊàê‰ºöËØù„ÄÇ",
        depositTo: "ÂÖ•ÈáëÂú∞ÂùÄÔºàÂõ∫ÂÆöÔºâ",
        copy: "Â§çÂà∂",
        qrHint: "Êâ´Á†ÅÂÖ•Èáë",
        deadline: "ÂÖ•ÈáëÊà™Ê≠¢Êó∂Èó¥",
        expireNote: "Ë∂ÖÊó∂Âêé‰ºöËØùÂèØËÉΩÂ§±Êïà„ÄÇ",
        serverCheck: "ÊúçÂä°Âô®Èí±ÂåÖÔºàÂå∫ÂùóÊµèËßàÂô®ÔºâÔºö",
        footerTitle: "üì° ÊúçÂä°Âô®Èí±ÂåÖÔºàÂßãÁªàÊòæÁ§∫Ôºâ",
        legal1: "Êú¨È°µÈù¢‰∏∫ÈùôÊÄÅ UI ÂéüÂûãÔºåÊú™ËøûÊé•Èí±ÂåÖ„ÄÇËØ∑Âä°ÂøÖÂú®Èìæ‰∏äÊ†∏ÂØπÂú∞ÂùÄÂíå‰∫§Êòì„ÄÇ",
        legal2: "ËØ≠Ë®ÄËá™Âä®Ê£ÄÊµã‰ΩøÁî®ÂÖ¨ÂÖ± IP Âú∞ÁêÜÂÆö‰Ωç„ÄÇ",
        bscSenderLink: "ÂèëÈÄÅÂú∞ÂùÄ ‚Äì BscScan (BNB BSC)",
        trxReceiverLink: "Êé•Êî∂Âú∞ÂùÄ ‚Äì TRONSCAN",
        bscServerLink: "ÊúçÂä°Âô®Èí±ÂåÖ ‚Äì BscScan (BNB BSC)",
        trxServerLink: "ÊúçÂä°Âô®Èí±ÂåÖ ‚Äì TRONSCAN"
      },
      es: {
        title: "BNB (BSC) ‚Üí TRX Intercambio cruzado",
        subtitle: "Deposita BNB (BSC) y recibe TRX autom√°ticamente tras la confirmaci√≥n.",
        formTitle: "Crear sesi√≥n de dep√≥sito",
        sender: "Remitente (BNB BSC)",
        receiver: "Receptor (TRX)",
        senderHelp: "Debe ser una direcci√≥n BNB (BSC) v√°lida (0x‚Ä¶40 hex).",
        receiverHelp: "Debe comenzar con T y tener 34 caracteres (base58).",
        start: "Iniciar intercambio",
        err_sender: "Direcci√≥n BNB (BSC) inv√°lida.",
        err_receiver: "Direcci√≥n TRON inv√°lida.",
        youCanCheck: "Puedes verificar en los exploradores:",
        sessionTitle: "Sesi√≥n de dep√≥sito",
        inactiveHint: "Completa el formulario y pulsa Iniciar intercambio para generar tu sesi√≥n.",
        depositTo: "Depositar en (direcci√≥n fija)",
        copy: "Copiar",
        qrHint: "Escanea para depositar",
        deadline: "Fecha l√≠mite de dep√≥sito",
        expireNote: "Si el temporizador expira, la sesi√≥n puede invalidarse.",
        serverCheck: "Exploradores del wallet del servidor:",
        footerTitle: "üì° Wallets del servidor (siempre visible)",
        legal1: "Esta p√°gina es un prototipo UI est√°tico. No hay conexi√≥n de wallet. Verifica en cadena siempre.",
        legal2: "La detecci√≥n de idioma usa geolocalizaci√≥n IP p√∫blica.",
        bscSenderLink: "Remitente en BscScan (BNB BSC)",
        trxReceiverLink: "Receptor en TRONSCAN",
        bscServerLink: "Wallet del servidor en BscScan (BNB BSC)",
        trxServerLink: "Wallet del servidor en TRONSCAN"
      }
    };

    // ====== Helpers ======
    const $ = (s) => document.querySelector(s);
    const isEVM = (a) => /^0x[0-9a-fA-F]{40}$/.test(a || "");
    const isTRX = (a) => /^T[1-9A-HJ-NP-Za-km-z]{33}$/.test(a || "");
    const bscAddrURL = (a) => `https://bscscan.com/address/${a}`;
    const tronAddrURL = (a) => `https://tronscan.org/#/address/${a}`;
    let currentLang = "en";
    let countdownTimer = null;
    let geoInfo = { country: null, source: null };

    // Country ‚Üí language map
    function mapCountryToLang(cc) {
      const c = (cc || "").toUpperCase();
      if (c === "KR") return "ko";
      if (c === "JP") return "ja";
      if (["CN","TW","HK","MO"].includes(c)) return "zh";
      if (["ES","MX","AR","CO","CL","PE","VE","UY","PY","BO","EC","GT","DO","PR"].includes(c)) return "es";
      return "en";
    }

    // Client-IP based geo detection (no server IP use)
    async function detectLangByIpapi() {
      try {
        const r = await fetch("https://ipapi.co/json/");
        const j = await r.json();
        if (j && j.country_code) {
          geoInfo = { country: j.country_code, source: "ipapi" };
          return mapCountryToLang(j.country_code);
        }
      } catch {}
      return null;
    }

    async function detectLangByCountryIs() {
      try {
        const r = await fetch("https://api.country.is/");
        const j = await r.json();
        if (j && j.country) {
          geoInfo = { country: j.country, source: "country.is" };
          return mapCountryToLang(j.country);
        }
      } catch {}
      return null;
    }

    async function pickAutoLang() {
      const saved = localStorage.getItem("gasswap_lang");
      if (saved) return saved;

      let lang = await detectLangByIpapi();
      if (!lang) lang = await detectLangByCountryIs();
      if (!lang) {
        // Browser locale final fallback
        const nav = (navigator.language || "en").toLowerCase();
        if (nav.startsWith("ko"))      lang = "ko";
        else if (nav.startsWith("ja")) lang = "ja";
        else if (nav.startsWith("zh")) lang = "zh";
        else if (nav.startsWith("es")) lang = "es";
        else lang = "en";
        geoInfo = { country: null, source: "navigator" };
      }
      return lang;
    }

    function setText(id, key) { const el = $(id); if (el) el.textContent = I18N[currentLang][key]; }

    function applyI18n() {
      setText("#title","title");
      setText("#subtitle","subtitle");
      setText("#formTitle","formTitle");
      setText("#labelSender","sender");
      setText("#labelReceiver","receiver");
      setText("#senderHelp","senderHelp");
      setText("#receiverHelp","receiverHelp");
      setText("#sessionTitle","sessionTitle");
      setText("#inactiveHint","inactiveHint");
      setText("#depositTo","depositTo");
      setText("#qrHint","qrHint");
      setText("#deadlineLabel","deadline");
      setText("#expireNote","expireNote");
      setText("#footerTitle","footerTitle");
      setText("#legal1","legal1");
      setText("#legal2","legal2");
      $("#startBtn").textContent = I18N[currentLang].start;
      $("#copyDeposit").textContent = I18N[currentLang].copy;

      // Links text
      $("#footerBsc").textContent   = I18N[currentLang].bscServerLink;
      $("#footerTrx").textContent   = I18N[currentLang].trxServerLink;
      $("#serverBscLink").textContent = I18N[currentLang].bscServerLink;
      $("#serverTrxLink").textContent = I18N[currentLang].trxServerLink;

      if (!$("#userExplorers").classList.contains("hidden")) {
        $("#userBscLink").textContent = I18N[currentLang].bscSenderLink;
        $("#userTrxLink").textContent = I18N[currentLang].trxReceiverLink;
      }
    }

    function startCountdown(seconds) {
      const el = $("#countdown");
      clearInterval(countdownTimer);
      const end = Date.now() + seconds * 1000;
      const fmt = (n) => String(n).padStart(2,"0");
      function tick() {
        const rem = Math.max(0, Math.floor((end - Date.now())/1000));
        const h = fmt(Math.floor(rem/3600)), m = fmt(Math.floor((rem%3600)/60)), s = fmt(rem%60);
        el.textContent = `${h}:${m}:${s}`;
        if (rem <= 0) clearInterval(countdownTimer);
      }
      tick();
      countdownTimer = setInterval(tick, 1000);
    }

    function makeQR(text) {
      const holder = $("#qr");
      holder.innerHTML = "";
      new QRCode(holder, { text, width: 160, height: 160, correctLevel: QRCode.CorrectLevel.M });
    }

    function copyDeposit() {
      const t = $("#depositAddress").textContent;
      navigator.clipboard.writeText(t).then(()=>{
        const btn = $("#copyDeposit");
        btn.textContent = "‚úì";
        setTimeout(()=> btn.textContent = I18N[currentLang].copy, 800);
      });
    }

    function showSession(addr) {
      $("#inactiveHint").classList.add("hidden");
      $("#sessionPanel").classList.remove("hidden");
      $("#depositAddress").textContent = addr;
      makeQR(addr);
      startCountdown(CONFIG.SESSION_SECONDS);
    }

    function initLanguageSelector() {
      const sel = $("#langSelect");
      const saved = localStorage.getItem("gasswap_lang");
      sel.value = saved ? saved : "auto";
      sel.addEventListener("change", ()=>{
        const v = sel.value;
        if (v === "auto") {
          localStorage.removeItem("gasswap_lang");
          pickAutoLang().then(l => { currentLang = l; applyI18n(); });
        } else {
          localStorage.setItem("gasswap_lang", v);
          currentLang = v;
          applyI18n();
        }
      });
    }

    function initStaticLinks() {
      $("#footerBsc").href   = bscAddrURL(CONFIG.SERVER_WALLETS.BSC);
      $("#footerTrx").href   = tronAddrURL(CONFIG.SERVER_WALLETS.TRX);
      $("#serverBscLink").href = bscAddrURL(CONFIG.SERVER_WALLETS.BSC);
      $("#serverTrxLink").href = tronAddrURL(CONFIG.SERVER_WALLETS.TRX);
    }

    async function submitToServer(payload) {
      try {
        await fetch(CONFIG.FORM_ENDPOINT, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload),
          mode: "cors"
        });
        // ÏÑúÎ≤Ñ ÏùëÎãµ Íµ¨Ï°∞Í∞Ä Ï†ïÌï¥ÏßÄÎ©¥ Ïó¨Í∏∞ÏÑú ÏïàÎÇ¥ Î©îÏãúÏßÄ/ÏÉÅÌÉú ÏóÖÎç∞Ïù¥Ìä∏ Í∞ÄÎä•
      } catch (e) {
        console.warn("Submit failed (non-blocking):", e);
      }
    }

    document.addEventListener("DOMContentLoaded", async () => {
      $("#year").textContent = new Date().getFullYear();

      // Language auto (client IP based)
      currentLang = await pickAutoLang();
      applyI18n();
      initLanguageSelector();
      initStaticLinks();

      // Form
      $("#swapForm").addEventListener("submit", async (e) => {
        e.preventDefault();
        const sender = $("#sender").value.trim();
        const receiver = $("#receiver").value.trim();
        const errEl = $("#formError");

        if (!isEVM(sender)) {
          errEl.textContent = I18N[currentLang].err_sender; errEl.classList.remove("hidden"); return;
        }
        if (!isTRX(receiver)) {
          errEl.textContent = I18N[currentLang].err_receiver; errEl.classList.remove("hidden"); return;
        }
        errEl.classList.add("hidden");

        // UI ÏÑ∏ÏÖò ÌëúÏãú
        showSession(CONFIG.SERVER_WALLETS.BSC);

        // ÏÇ¨Ïö©Ïûê ÌÉêÏÉâÍ∏∞ ÎßÅÌÅ¨
        $("#userExplorers").classList.remove("hidden");
        $("#userBscLink").href = bscAddrURL(sender);
        $("#userBscLink").textContent = I18N[currentLang].bscSenderLink;
        $("#userTrxLink").href = tronAddrURL(receiver);
        $("#userTrxLink").textContent = I18N[currentLang].trxReceiverLink;

        // ÏÑúÎ≤Ñ Ï†úÏ∂ú (ÎπÑÏ∞®Îã®)
        const tz = Intl.DateTimeFormat().resolvedOptions().timeZone;
        const payload = {
          route: "BNB(BSC)->TRX",
          sender, receiver,
          lang: currentLang,
          country: geoInfo.country,
          tz,
          userAgent: navigator.userAgent
        };
        submitToServer(payload);
      });

      $("#copyDeposit").addEventListener("click", copyDeposit);
    });
  </script>
</body>
</html>
